<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Text Adder — All Pages Visible</title>

  <!-- PDF लाइब्रेरीज -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

  <!-- स्टाइलिंग और आइकन्स -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- कलर पिकर लाइब्रेरी -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>

  <style>
    *{ box-sizing:border-box; font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial; }
    html,body{ height:100%; margin:0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#e6eef8; }
    body{ display:flex; align-items:flex-start; justify-content:center; padding:28px; }

    .container{
      width:100%; max-width:980px; background:rgba(255,255,255,0.08);
      backdrop-filter: blur(10px); border-radius:16px; padding:20px 22px 160px;
      border:1px solid rgba(255,255,255,0.1); box-shadow:0 12px 40px rgba(0,0,0,0.6);
      min-height: 60px;
    }

    .header{ display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .header h1{ margin:0; font-size:20px; font-weight:700; color:#fff; display:flex; gap:10px; align-items:center;}
    .header i{ color:#60a5fa; font-size:26px; }

    .upload-area{
      border:2px dashed rgba(255,255,255,0.25); padding:20px; border-radius:12px; text-align:center; cursor:pointer; background:rgba(255,255,255,0.05);
      margin-bottom:14px; position:relative; transition: all 0.3s ease;
    }
    .upload-area:hover{ border-color:#60a5fa; background:rgba(96,165,250,0.08); }
    .upload-area i{ font-size:34px; color:#60a5fa; display:block; margin-bottom:8px; }
    .upload-area input[type=file]{ position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer; }
    .upload-area h3{ margin:0 0 8px; color:#cfe8ff; }
    .upload-area p{ margin:0; color:rgba(255,255,255,0.7); font-size:14px; }

    .preview-list{ display:flex; flex-direction:column; gap:18px; padding-right:6px; }

    .preview-item{ background:rgba(255,255,255,0.05); border-radius:10px; padding:12px; display:flex; flex-direction:column; align-items:center; }
    .preview-item h3{ margin:0 0 8px; color:#cfe8ff; font-weight:700; width:100%; text-align:left; }

    .canvas-wrap{ position:relative; width:100%; display:flex; justify-content:center; }
    canvas{ width:100% !important; height:auto !important; border-radius:6px; box-shadow:0 8px 30px rgba(0,0,0,0.6); background:white; display:block; max-width: 100%; }

    .text-layer{ position:absolute; left:0; top:0; pointer-events:auto; }

    .text-element{ 
      position:absolute; cursor:move; touch-action:none; user-select:none; 
      display:flex; align-items:center; transition:transform 120ms ease;
      padding: 4px 8px; border-radius: 4px; background: rgba(0,0,0,0.05);
      border: 2px solid transparent;
      max-width: 300px;
      word-wrap: break-word;
    }
    .text-element.selected{ border-color: #60a5fa; background: rgba(96,165,250,0.1); }
    .text-element.pulse{ animation: textPulse 360ms ease; }
    @keyframes textPulse { 0% { transform: scale(1); } 50% { transform: scale(1.06); } 100% { transform: scale(1); } }

    .text-content{ 
      pointer-events:none; font-family: Arial, sans-serif;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.2;
      min-height: 1.2em;
      width: 100%;
    }

    /* टेक्स्ट कंट्रोल बार - छोटा और कॉम्पैक्ट */
    .text-controls-bar {
      position: absolute;
      bottom: calc(100% + 3px);
      left: 50%;
      transform: translateX(-50%);
      display: none;
      flex-direction: row;
      gap: 4px;
      background: rgba(30, 30, 35, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 4px 6px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.15);
      z-index: 100;
      align-items: center;
      min-width: 180px;
      justify-content: center;
    }
    
    .text-element.selected .text-controls-bar {
      display: flex;
      animation: controlsFade 0.2s ease;
    }
    
    @keyframes controlsFade {
      from { opacity: 0; transform: translateX(-50%) translateY(5px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* छोटे गोलाकार बटन्स */
    .control-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s ease;
      background: rgba(255,255,255,0.1);
      color: white;
      position: relative;
    }
    
    .control-btn:hover {
      transform: scale(1.1);
      background: rgba(255,255,255,0.2);
    }
    
    .control-btn.active {
      background: #3b82f6;
      color: white;
    }
    
    /* स्पेशल बटन्स */
    .size-btn {
      font-size: 14px;
      font-weight: 700;
    }
    
    .bold-btn {
      font-weight: 900;
    }
    
    .italic-btn {
      font-style: italic;
      font-weight: 600;
    }
    
    .underline-btn {
      text-decoration: underline;
      font-weight: 600;
    }
    
    .color-btn {
      position: relative;
      overflow: hidden;
      padding: 0;
    }
    
    .color-preview-inline {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
    }
    
    /* फॉन्ट साइज डिस्प्ले - छोटा */
    .font-size-display {
      color: white;
      font-weight: 700;
      font-size: 10px;
      min-width: 20px;
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 3px 5px;
      border-radius: 8px;
      margin: 0 1px;
    }
    
    /* डिलीट बटन - छोटा */
    .delete-btn{ 
      position:absolute; right:-10px; top:-10px; width:22px; height:22px; 
      background:#ef4444; color:white; border-radius:50%; border:none;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      font-size: 10px;
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .delete-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }
    
    /* मल्टी-लाइन टेक्स्ट इंडिकेटर */
    .multi-line-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 8px;
      padding: 1px 3px;
      border-radius: 2px;
      display: none;
    }
    
    .text-element.multi-line .multi-line-indicator {
      display: block;
    }
    
    /* कलर पिकर पॉपअप - छोटा */
    .color-picker-popup {
      position: fixed;
      background: rgba(30, 30, 35, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.2);
      z-index: 10000;
      display: none;
      min-width: 180px;
      animation: popupFade 0.2s ease;
    }
    
    @keyframes popupFade {
      from { opacity: 0; transform: translateY(5px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .color-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    
    .color-picker-header h4 {
      margin: 0;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    
    .close-color-picker {
      background: rgba(255,255,255,0.1);
      border: none;
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      cursor: pointer;
      padding: 4px;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .close-color-picker:hover {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    .color-picker-container {
      padding: 8px 0;
    }
    
    .color-options {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-bottom: 10px;
    }
    
    .color-option {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.3);
      transition: all 0.2s ease;
    }
    
    .color-option:hover {
      transform: scale(1.1);
      border-color: white;
    }
    
    .color-option.selected {
      border-color: white;
      box-shadow: 0 0 0 2px #3b82f6;
    }
    
    .custom-color-input {
      width: 100%;
      padding: 6px 8px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 6px;
      color: white;
      font-size: 11px;
      margin-top: 8px;
    }
    
    .custom-color-input:focus {
      outline: none;
      border-color: #60a5fa;
      background: rgba(255,255,255,0.15);
    }

    .floating-btn{
      position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:9999;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px) saturate(1.05);
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 12px 30px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.08);
      color: white; padding:12px 28px; border-radius:999px; font-weight:800; cursor:pointer; display:flex; gap:10px; align-items:center;
      transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }
    .floating-btn:hover{ transform:translateX(-50%) translateY(-4px); box-shadow:0 18px 44px rgba(0,0,0,0.6); background: rgba(255,255,255,0.12); }
    .floating-btn:disabled{ opacity:0.6; cursor:not-allowed; }

    .progress{ position:fixed; left:50%; transform:translateX(-50%); bottom:78px; width:420px; height:8px; background:rgba(255,255,255,0.04); border-radius:8px; overflow:hidden; display:none; z-index:9998; }
    .progress > div{ width:0%; height:100%; background:linear-gradient(90deg,#5b86e5,#36d1dc); transition:width 200ms linear; }

    .footer-note{ margin-top:12px; color:rgba(255,255,255,0.6); font-size:13px; text-align:center; }

    @media (max-width:860px){
      .container{ padding-bottom:220px; }
      .progress{ width:86%; }
      .floating-btn{ width:86%; left:50%; transform:translateX(-50%); }
      .text-controls-bar {
        gap: 4px;
        padding: 4px 6px;
        min-width: 160px;
      }
      .control-btn {
        width: 22px;
        height: 22px;
        font-size: 10px;
      }
      .font-size-display {
        font-size: 9px;
        min-width: 18px;
      }
    }

    /* Spectrum color picker fix */
    .sp-container { 
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      z-index: 10001 !important;
      background: rgba(30, 30, 35, 0.98) !important;
      backdrop-filter: blur(20px) !important;
      border: 1px solid rgba(255,255,255,0.2) !important;
      border-radius: 16px !important;
    }
    
    .sp-palette-container { border-right: 1px solid rgba(255,255,255,0.1) !important; }
    
    /* लोडिंग इंडिकेटर */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: rgba(255,255,255,0.7);
      font-size: 16px;
      gap: 15px;
      flex-direction: column;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* एरर मैसेज */
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: #ef4444;
      margin: 20px 0;
    }
    
    /* सफलता मैसेज */
    .success-message {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: #22c55e;
      margin: 20px 0;
    }
    
    /* पेज काउंटर */
    .page-counter {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      z-index: 1000;
      backdrop-filter: blur(10px);
      display: none;
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="header">
      <i class="fas fa-font"></i>
      <h1>PDF Text Adder</h1>
    </div>

    <div class="upload-area" id="uploadArea">
      <i class="fas fa-cloud-upload-alt"></i>
      <h3>Upload a PDF</h3>
      <p>Select a PDF and click anywhere on the pages to add text. Click text to show editing controls.</p>
      <input id="pdfInput" type="file" accept="application/pdf">
    </div>

    <div class="preview-list" id="previewList" aria-live="polite"></div>

    <div class="footer-note">Click anywhere on a page to add text. Drag to reposition. Click text to show editing controls.</div>
  </div>

  <!-- Color Picker Popup -->
  <div class="color-picker-popup" id="colorPickerPopup">
    <div class="color-picker-header">
      <h4><i class="fas fa-palette"></i> Select Color</h4>
      <button class="close-color-picker" id="closeColorPickerBtn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="color-picker-container">
      <div class="color-options" id="colorOptions">
        <div class="color-option" style="background-color: #000000;" data-color="#000000"></div>
        <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
        <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div>
        <div class="color-option" style="background-color: #00ff00;" data-color="#00ff00"></div>
        <div class="color-option" style="background-color: #0000ff;" data-color="#0000ff"></div>
        <div class="color-option" style="background-color: #ffff00;" data-color="#ffff00"></div>
        <div class="color-option" style="background-color: #ff00ff;" data-color="#ff00ff"></div>
        <div class="color-option" style="background-color: #00ffff;" data-color="#00ffff"></div>
        <div class="color-option" style="background-color: #ff8000;" data-color="#ff8000"></div>
        <div class="color-option" style="background-color: #8000ff;" data-color="#8000ff"></div>
      </div>
      
      <input type="text" class="custom-color-input" id="customColorInput" placeholder="Enter hex color (e.g. #3b82f6)" value="#000000">
    </div>
  </div>

  <div class="progress" id="progress"><div id="progressBar"></div></div>
  <button class="floating-btn" id="generateBtn" disabled><i class="fas fa-download"></i> Generate PDF with Text</button>
  
  <!-- पेज काउंटर -->
  <div class="page-counter" id="pageCounter"></div>

<script>
document.addEventListener('DOMContentLoaded', ()=> {
  console.log('PDF Text Adder Application Loading...');
  
  // DOM elements
  const pdfInput = document.getElementById('pdfInput');
  const uploadArea = document.getElementById('uploadArea');
  const previewList = document.getElementById('previewList');
  const generateBtn = document.getElementById('generateBtn');
  const progress = document.getElementById('progress');
  const progressBar = document.getElementById('progressBar');
  const container = document.getElementById('container');
  const pageCounter = document.getElementById('pageCounter');
  
  // Color picker elements
  const colorPickerPopup = document.getElementById('colorPickerPopup');
  const closeColorPickerBtn = document.getElementById('closeColorPickerBtn');
  const colorOptions = document.getElementById('colorOptions');
  const customColorInput = document.getElementById('customColorInput');

  // Device pixel ratio
  const DPR = window.devicePixelRatio || 1;
  
  // Global variables
  let selectedPdfFile = null;
  let pdfLibDoc = null;
  let pdfJsDoc = null;
  let pageData = [];
  let originalFilename = '';
  let selectedTextElement = null;
  let isCreatingNewText = false;
  let currentPageIndex = 0;
  let clickPosition = { x: 0, y: 0 };
  
  // Global text style (जो सभी नए टेक्स्ट के लिए apply होगी)
  let globalTextStyle = {
    text: "Type here",
    fontSize: 16,
    color: "#000000",
    bold: false,
    italic: false,
    underline: false
  };
  
  // Track which color button was clicked
  let activeColorButton = null;
  
  // Track if user is currently typing in a text element
  let isTypingInText = false;
  
  // Color picker initialization
  try {
    if (typeof jQuery !== 'undefined' && jQuery.fn.spectrum) {
      console.log('Spectrum color picker available');
    } else {
      console.warn('Spectrum color picker not available');
    }
  } catch (error) {
    console.error('Error initializing color picker:', error);
  }

  // Color picker events
  closeColorPickerBtn.addEventListener('click', hideColorPicker);
  
  colorOptions.addEventListener('click', (e) => {
    const colorOption = e.target.closest('.color-option');
    if (colorOption) {
      const color = colorOption.dataset.color;
      customColorInput.value = color;
      applyColorToSelectedText(color);
      updateColorPreview(activeColorButton, color);
    }
  });
  
  customColorInput.addEventListener('change', () => {
    const color = customColorInput.value;
    if (isValidHexColor(color)) {
      applyColorToSelectedText(color);
      updateColorPreview(activeColorButton, color);
      hideColorPicker();
    } else {
      alert('Please enter a valid hex color (e.g. #000000 or #3b82f6)');
    }
  });
  
  // Show color picker
  function showColorPicker(button, currentColor) {
    activeColorButton = button;
    customColorInput.value = currentColor;
    
    // Update selected color in options
    document.querySelectorAll('.color-option').forEach(option => {
      option.classList.remove('selected');
      if (option.dataset.color === currentColor.toLowerCase()) {
        option.classList.add('selected');
      }
    });
    
    // Position popup near the button
    const rect = button.getBoundingClientRect();
    const popupWidth = 180;
    const popupHeight = 160;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let posX = rect.left;
    let posY = rect.bottom + 5;
    
    // Adjust if goes beyond viewport
    if (posX + popupWidth > viewportWidth) {
      posX = viewportWidth - popupWidth - 10;
    }
    if (posY + popupHeight > viewportHeight) {
      posY = rect.top - popupHeight - 5;
    }
    
    colorPickerPopup.style.left = posX + 'px';
    colorPickerPopup.style.top = posY + 'px';
    colorPickerPopup.style.display = 'block';
    
    // Focus on input
    setTimeout(() => {
      customColorInput.focus();
      customColorInput.select();
    }, 10);
  }
  
  // Hide color picker
  function hideColorPicker() {
    colorPickerPopup.style.display = 'none';
    activeColorButton = null;
  }
  
  // Close color picker when clicking outside
  document.addEventListener('click', (e) => {
    if (colorPickerPopup.style.display === 'block' && 
        !colorPickerPopup.contains(e.target) && 
        !e.target.classList.contains('color-btn') &&
        !e.target.closest('.color-btn')) {
      hideColorPicker();
    }
  });
  
  // Validate hex color
  function isValidHexColor(color) {
    return /^#([0-9A-F]{3}){1,2}$/i.test(color);
  }
  
  // Update color preview in button
  function updateColorPreview(button, color) {
    if (button) {
      const preview = button.querySelector('.color-preview-inline');
      if (preview) {
        preview.style.backgroundColor = color;
      }
    }
  }
  
  // Apply color to selected text
  function applyColorToSelectedText(color) {
    if (!selectedTextElement) return;
    
    globalTextStyle.color = color;
    
    const textContent = selectedTextElement.querySelector('.text-content');
    textContent.style.color = color;
    
    // Update text data in storage
    const pageIndex = selectedTextElement.dataset.pageIndex;
    const textId = selectedTextElement.dataset.textId;
    const pd = pageData[pageIndex];
    
    if (!pd || !pd.texts) return;
    
    const textData = pd.texts.find(t => t.id === textId);
    if (!textData) return;
    
    textData.color = color;
    
    // Update color preview in controls bar
    const colorBtn = selectedTextElement.querySelector('.color-btn');
    if (colorBtn) {
      updateColorPreview(colorBtn, color);
    }
  }

  // Apply current style to selected text
  function applyStyleToSelectedText() {
    if (!selectedTextElement) return;
    
    const textContent = selectedTextElement.querySelector('.text-content');
    textContent.style.fontSize = globalTextStyle.fontSize + 'px';
    textContent.style.color = globalTextStyle.color;
    textContent.style.fontWeight = globalTextStyle.bold ? 'bold' : 'normal';
    textContent.style.fontStyle = globalTextStyle.italic ? 'italic' : 'normal';
    textContent.style.textDecoration = globalTextStyle.underline ? 'underline' : 'none';
    
    // Check if text has multiple lines
    if (textContent.textContent.includes('\n')) {
      selectedTextElement.classList.add('multi-line');
    } else {
      selectedTextElement.classList.remove('multi-line');
    }
    
    // Update text data in storage
    const pageIndex = selectedTextElement.dataset.pageIndex;
    const textId = selectedTextElement.dataset.textId;
    const pd = pageData[pageIndex];
    
    if (!pd || !pd.texts) return;
    
    const textData = pd.texts.find(t => t.id === textId);
    if (!textData) return;
    
    // Update the stored data with current global style
    textData.fontSize = globalTextStyle.fontSize;
    textData.color = globalTextStyle.color;
    textData.bold = globalTextStyle.bold;
    textData.italic = globalTextStyle.italic;
    textData.underline = globalTextStyle.underline;
    
    // Update controls bar display
    updateControlsBar(selectedTextElement);
  }
  
  // Update controls bar UI
  function updateControlsBar(textElement) {
    const sizeDisplay = textElement.querySelector('.font-size-display');
    const boldBtn = textElement.querySelector('.bold-btn');
    const italicBtn = textElement.querySelector('.italic-btn');
    const underlineBtn = textElement.querySelector('.underline-btn');
    const colorBtn = textElement.querySelector('.color-btn');
    
    if (sizeDisplay) {
      sizeDisplay.textContent = globalTextStyle.fontSize;
    }
    
    if (boldBtn) {
      boldBtn.classList.toggle('active', globalTextStyle.bold);
    }
    
    if (italicBtn) {
      italicBtn.classList.toggle('active', globalTextStyle.italic);
    }
    
    if (underlineBtn) {
      underlineBtn.classList.toggle('active', globalTextStyle.underline);
    }
    
    if (colorBtn) {
      updateColorPreview(colorBtn, globalTextStyle.color);
    }
  }

  // Select text element and show controls
  function selectTextElement(element) {
    // Deselect previous
    if (selectedTextElement && selectedTextElement !== element) {
      selectedTextElement.classList.remove('selected');
    }
    
    // Select new
    selectedTextElement = element;
    element.classList.add('selected');
    
    // Update global style from this text
    const pageIndex = element.dataset.pageIndex;
    const textId = element.dataset.textId;
    const pd = pageData[pageIndex];
    
    if (pd && pd.texts) {
      const textData = pd.texts.find(t => t.id === textId);
      if (textData) {
        globalTextStyle.text = textData.text;
        globalTextStyle.fontSize = textData.fontSize;
        globalTextStyle.color = textData.color;
        globalTextStyle.bold = textData.bold;
        globalTextStyle.italic = textData.italic;
        globalTextStyle.underline = textData.underline;
      }
    }
    
    // Update controls bar
    updateControlsBar(element);
    
    // Enable typing in text
    enableTypingInText(element);
  }

  // Enable typing in text element
  function enableTypingInText(textElement) {
    const textContent = textElement.querySelector('.text-content');
    
    // Make text content editable for typing
    textElement.addEventListener('dblclick', handleDoubleClick);
    
    function handleDoubleClick(e) {
      e.stopPropagation();
      startTypingInText(textElement, textContent);
    }
  }
  
  // Start typing in text element
  function startTypingInText(textElement, textContent) {
    isTypingInText = true;
    
    // Create an input overlay for typing
    const inputOverlay = document.createElement('div');
    inputOverlay.className = 'text-input-overlay';
    inputOverlay.style.position = 'absolute';
    inputOverlay.style.left = '0';
    inputOverlay.style.top = '0';
    inputOverlay.style.width = '100%';
    inputOverlay.style.height = '100%';
    inputOverlay.style.background = 'transparent';
    inputOverlay.style.border = '2px solid #3b82f6';
    inputOverlay.style.borderRadius = '4px';
    inputOverlay.style.zIndex = '50';
    
    // Create textarea for typing
    const textarea = document.createElement('textarea');
    textarea.style.width = '100%';
    textarea.style.height = '100%';
    textarea.style.background = 'rgba(255,255,255,0.9)';
    textarea.style.border = 'none';
    textarea.style.outline = 'none';
    textarea.style.padding = '4px 8px';
    textarea.style.fontFamily = 'Arial, sans-serif';
    textarea.style.fontSize = globalTextStyle.fontSize + 'px';
    textarea.style.color = globalTextStyle.color;
    textarea.style.fontWeight = globalTextStyle.bold ? 'bold' : 'normal';
    textarea.style.fontStyle = globalTextStyle.italic ? 'italic' : 'normal';
    textarea.style.textDecoration = globalTextStyle.underline ? 'underline' : 'none';
    textarea.style.resize = 'none';
    textarea.value = textContent.textContent;
    
    // Auto-resize textarea
    function autoResize() {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight) + 'px';
      inputOverlay.style.height = (textarea.scrollHeight) + 'px';
    }
    
    textarea.addEventListener('input', autoResize);
    
    inputOverlay.appendChild(textarea);
    textElement.appendChild(inputOverlay);
    
    // Focus and select all text
    setTimeout(() => {
      textarea.focus();
      textarea.select();
    }, 10);
    
    // Handle Enter key for new line (Shift+Enter for new line, just Enter to finish)
    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        finishTyping(textElement, textContent, textarea, inputOverlay);
      }
    });
    
    // Handle blur (click outside)
    textarea.addEventListener('blur', function() {
      finishTyping(textElement, textContent, textarea, inputOverlay);
    });
    
    // Initial resize
    autoResize();
  }
  
  // Finish typing and update text
  function finishTyping(textElement, textContent, textarea, inputOverlay) {
    if (!isTypingInText) return;
    
    const newText = textarea.value.trim();
    if (newText !== '') {
      textContent.textContent = newText;
      
      // Update global style and stored data
      globalTextStyle.text = newText;
      
      const pageIndex = textElement.dataset.pageIndex;
      const textId = textElement.dataset.textId;
      const pd = pageData[pageIndex];
      
      if (pd && pd.texts) {
        const textData = pd.texts.find(t => t.id === textId);
        if (textData) {
          textData.text = newText;
        }
      }
      
      // Check if text has multiple lines
      if (newText.includes('\n')) {
        textElement.classList.add('multi-line');
      } else {
        textElement.classList.remove('multi-line');
      }
    }
    
    // Remove input overlay
    if (inputOverlay.parentNode) {
      inputOverlay.parentNode.removeChild(inputOverlay);
    }
    
    isTypingInText = false;
  }

  // Hide color picker
  document.addEventListener('click', (e) => {
    if (colorPickerPopup.style.display === 'block' && 
        !colorPickerPopup.contains(e.target) && 
        !e.target.classList.contains('color-btn') &&
        !e.target.closest('.color-btn')) {
      hideColorPicker();
    }
  });

  // Drag/drop UI for PDF upload
  ['dragenter','dragover'].forEach(ev => uploadArea.addEventListener(ev, e=>{ 
    e.preventDefault(); 
    uploadArea.style.borderColor = '#60a5fa';
    uploadArea.style.background = 'rgba(96,165,250,0.08)';
  }));
  
  ['dragleave','drop'].forEach(ev => uploadArea.addEventListener(ev, e=>{ 
    e.preventDefault(); 
    uploadArea.style.borderColor = 'rgba(255,255,255,0.25)';
    uploadArea.style.background = 'rgba(255,255,255,0.05)';
  }));
  
  uploadArea.addEventListener('drop', e=> { 
    e.preventDefault();
    if(e.dataTransfer?.files?.length) {
      handlePdf(e.dataTransfer.files[0]);
    }
  });

  pdfInput.addEventListener('change', (e)=> { 
    if(e.target.files?.length) {
      handlePdf(e.target.files[0]);
    }
  });

  // Main PDF handling function
  async function handlePdf(file){
    if(!file) return;
    
    // Validate file type
    if(file.type !== 'application/pdf'){ 
      showError('Please upload a PDF file');
      return; 
    }
    
    console.log('Processing PDF file:', file.name, 'Size:', file.size);
    
    // Reset state
    selectedPdfFile = file;
    previewList.innerHTML = '';
    pageData = [];
    selectedTextElement = null;
    generateBtn.disabled = true;
    hideColorPicker();
    
    // Show loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading';
    loadingDiv.innerHTML = `
      <div class="loading-spinner"></div>
      <div>Loading PDF...</div>
      <div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 10px;">Please wait</div>
    `;
    previewList.appendChild(loadingDiv);

    try {
      console.log('Reading file as ArrayBuffer...');
      const fileArrayBuffer = await file.arrayBuffer();
      originalFilename = file.name.replace(/\.pdf$/i, '');
      
      // Load PDF with pdf-lib for editing
      console.log('Loading PDF with PDF-lib...');
      if (typeof PDFLib === 'undefined') {
        throw new Error('PDF-lib library not loaded');
      }
      pdfLibDoc = await PDFLib.PDFDocument.load(fileArrayBuffer);
      const pdfLibPages = pdfLibDoc.getPageCount();
      console.log('PDF-lib loaded successfully. Pages:', pdfLibPages);
      
      // Load PDF with pdf.js for rendering
      console.log('Loading PDF with PDF.js...');
      if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js library not loaded');
      }
      
      // Configure PDF.js worker
      if (pdfjsLib.GlobalWorkerOptions) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
      }
      
      pdfJsDoc = await pdfjsLib.getDocument({data: fileArrayBuffer}).promise;
      const totalPages = pdfJsDoc.numPages;
      console.log('PDF.js loaded successfully. Total pages:', totalPages);
      
      if (totalPages === 0) {
        throw new Error('PDF file has no pages');
      }
      
      // Update page counter
      pageCounter.textContent = `Pages: ${totalPages}`;
      pageCounter.style.display = 'block';
      
      // Clear loading indicator
      previewList.innerHTML = '';
      
      // Calculate available width for rendering
      const cs = getComputedStyle(container);
      const padLeft = parseFloat(cs.paddingLeft) || 20;
      const padRight = parseFloat(cs.paddingRight) || 20;
      const availableWidth = Math.min(800, container.clientWidth - padLeft - padRight - 4);
      console.log('Available width for rendering:', availableWidth);

      // Render all pages
      for(let pageNum = 1; pageNum <= totalPages; pageNum++) {
        try {
          console.log(`Rendering page ${pageNum}...`);
          
          // Update progress
          const progressPercent = Math.round((pageNum / totalPages) * 100);
          if (pageNum === 1) {
            previewList.innerHTML = `
              <div class="loading">
                <div class="loading-spinner"></div>
                <div>Rendering page ${pageNum} of ${totalPages} (${progressPercent}%)</div>
              </div>
            `;
          }
          
          const page = await pdfJsDoc.getPage(pageNum);
          const baseViewport = page.getViewport({scale: 1});
          const scale = availableWidth / baseViewport.width;
          const viewport = page.getViewport({scale});
          
          const cssWidth = Math.round(viewport.width);
          const cssHeight = Math.round(viewport.height);
          console.log(`Page ${pageNum} dimensions: ${cssWidth}x${cssHeight}`);

          // Create canvas for this page
          const canvas = document.createElement('canvas');
          canvas.style.width = cssWidth + 'px';
          canvas.style.height = cssHeight + 'px';
          canvas.width = Math.floor(cssWidth * DPR);
          canvas.height = Math.floor(cssHeight * DPR);
          
          const ctx = canvas.getContext('2d');
          ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
          
          // Render the page
          await page.render({
            canvasContext: ctx,
            viewport: viewport
          }).promise;

          // Get page size from pdf-lib
          const libPage = pdfLibDoc.getPage(pageNum - 1);
          const pageSize = libPage.getSize();

          // Create page item
          const pageItem = document.createElement('div');
          pageItem.className = 'preview-item';
          
          const pageTitle = document.createElement('h3');
          pageTitle.textContent = `Page ${pageNum}`;
          pageItem.appendChild(pageTitle);

          const wrap = document.createElement('div');
          wrap.className = 'canvas-wrap';
          wrap.style.width = cssWidth + 'px';
          wrap.style.height = cssHeight + 'px';
          wrap.appendChild(canvas);

          // Create text layer
          const textLayer = document.createElement('div');
          textLayer.className = 'text-layer';
          textLayer.style.width = cssWidth + 'px';
          textLayer.style.height = cssHeight + 'px';
          textLayer.style.left = '0';
          textLayer.style.top = '0';
          textLayer.style.position = 'absolute';
          wrap.style.position = 'relative';
          wrap.appendChild(textLayer);

          pageItem.appendChild(wrap);
          previewList.appendChild(pageItem);

          // Store page data
          pageData[pageNum - 1] = {
            pdfSize: { width: pageSize.width, height: pageSize.height },
            viewport: { width: viewport.width, height: viewport.height },
            canvasElem: canvas,
            layerElem: textLayer,
            wrapElem: wrap,
            texts: []
          };

          // Add click event to layer for adding text
          textLayer.addEventListener('click', (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            
            const rect = textLayer.getBoundingClientRect();
            const layerX = ev.clientX - rect.left;
            const layerY = ev.clientY - rect.top;
            
            // Check if click is on existing text or controls
            const existingTexts = Array.from(textLayer.querySelectorAll('.text-element'));
            for(const textEl of existingTexts) {
              const textRect = textEl.getBoundingClientRect();
              const deleteBtn = textEl.querySelector('.delete-btn');
              
              // Check if click is on delete button
              if (deleteBtn && isClickOnElement(ev, deleteBtn)) {
                return; // Delete button handler will handle this
              }
              
              // Check if click is on controls bar
              const controlsBar = textEl.querySelector('.text-controls-bar');
              if (controlsBar && isClickOnElement(ev, controlsBar)) {
                // Check which button was clicked
                const targetBtn = ev.target.closest('.control-btn');
                if (targetBtn) {
                  handleControlButtonClick(targetBtn, textEl);
                }
                return;
              }
              
              // Check if click is on text element itself
              if(ev.clientX >= textRect.left && ev.clientX <= textRect.right && 
                 ev.clientY >= textRect.top && ev.clientY <= textRect.bottom) {
                // Select existing text
                selectTextElement(textEl);
                return;
              }
            }
            
            // Add new text - FRESH TEXT with default "Type here"
            currentPageIndex = pageNum - 1;
            clickPosition = { x: ev.clientX, y: ev.clientY };
            
            // Reset global text to default for new text
            globalTextStyle.text = "Type here";
            addTextToPage(currentPageIndex, layerX, layerY);
          });
          
          console.log(`Page ${pageNum} rendered successfully`);
          
        } catch (pageError) {
          console.error(`Error rendering page ${pageNum}:`, pageError);
          // Add error message for this page
          const errorItem = document.createElement('div');
          errorItem.className = 'preview-item';
          errorItem.innerHTML = `
            <h3>Page ${pageNum} - Error</h3>
            <div class="error-message">
              <p>Could not render this page</p>
              <p style="font-size: 12px;">${pageError.message || 'Unknown error'}</p>
            </div>
          `;
          previewList.appendChild(errorItem);
          
          // Still add empty page data to maintain array structure
          pageData[pageNum - 1] = {
            pdfSize: { width: 595, height: 842 }, // Default A4 size
            viewport: { width: 595, height: 842 },
            texts: []
          };
        }
      }

      // Enable generate button if there are texts
      generateBtn.disabled = pageData.every(pd => !pd.texts || pd.texts.length === 0);
      
      // Show success message
      if (totalPages > 0) {
        const successMsg = document.createElement('div');
        successMsg.className = 'success-message';
        successMsg.innerHTML = `
          <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p><strong>PDF loaded successfully!</strong></p>
          <p>${totalPages} pages rendered. Click on any page to add text.</p>
        `;
        previewList.insertBefore(successMsg, previewList.firstChild);
      }
      
      // Scroll to show the first page
      if (previewList.children.length > 0) {
        previewList.children[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

    } catch(error) {
      console.error('Error loading PDF:', error);
      showError(`Error loading PDF: ${error.message || 'Please check if the PDF file is valid and not corrupted.'}`);
    }
  }

  // Handle control button clicks
  function handleControlButtonClick(button, textElement) {
    const buttonClass = button.className;
    
    if (buttonClass.includes('size-minus')) {
      // Decrease font size
      if (globalTextStyle.fontSize > 8) {
        globalTextStyle.fontSize--;
        applyStyleToSelectedText();
      }
    } else if (buttonClass.includes('size-plus')) {
      // Increase font size
      if (globalTextStyle.fontSize < 72) {
        globalTextStyle.fontSize++;
        applyStyleToSelectedText();
      }
    } else if (buttonClass.includes('bold-btn')) {
      // Toggle bold
      globalTextStyle.bold = !globalTextStyle.bold;
      applyStyleToSelectedText();
    } else if (buttonClass.includes('italic-btn')) {
      // Toggle italic
      globalTextStyle.italic = !globalTextStyle.italic;
      applyStyleToSelectedText();
    } else if (buttonClass.includes('underline-btn')) {
      // Toggle underline
      globalTextStyle.underline = !globalTextStyle.underline;
      applyStyleToSelectedText();
    } else if (buttonClass.includes('color-btn')) {
      // Show color picker
      showColorPicker(button, globalTextStyle.color);
    }
  }

  // Check if click is on specific element
  function isClickOnElement(ev, element) {
    const rect = element.getBoundingClientRect();
    return ev.clientX >= rect.left && ev.clientX <= rect.right && 
           ev.clientY >= rect.top && ev.clientY <= rect.bottom;
  }

  // Show error message
  function showError(message) {
    previewList.innerHTML = `
      <div class="error-message">
        <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
        <h3 style="margin: 0 0 10px 0;">Error</h3>
        <p>${message}</p>
        <button id="retryButton" style="margin-top: 15px; padding: 8px 16px; background: #60a5fa; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Try Again
        </button>
      </div>
    `;
    
    // Add retry button event listener
    document.getElementById('retryButton')?.addEventListener('click', () => {
      pdfInput.value = '';
      previewList.innerHTML = '';
      pageCounter.style.display = 'none';
    });
  }

  // Add text to page function
  function addTextToPage(pageIndex, x_css, y_css){
    const pd = pageData[pageIndex];
    if(!pd) return;
    const layer = pd.layerElem;
    const id = `text-${pageIndex}-${Date.now()}`;
    
    // Create text element
    const textEl = document.createElement('div');
    textEl.className = 'text-element';
    textEl.id = id;
    textEl.dataset.pageIndex = pageIndex;
    textEl.dataset.textId = id;
    
    // Position the text
    const left = Math.max(10, x_css);
    const top = Math.max(10, y_css);
    textEl.style.left = left + 'px';
    textEl.style.top = top + 'px';
    
    // Create text content
    const textContent = document.createElement('div');
    textContent.className = 'text-content';
    textContent.textContent = globalTextStyle.text;
    textContent.style.fontSize = globalTextStyle.fontSize + 'px';
    textContent.style.color = globalTextStyle.color;
    textContent.style.fontWeight = globalTextStyle.bold ? 'bold' : 'normal';
    textContent.style.fontStyle = globalTextStyle.italic ? 'italic' : 'normal';
    textContent.style.textDecoration = globalTextStyle.underline ? 'underline' : 'none';
    textEl.appendChild(textContent);
    
    // Add multi-line indicator
    const multiLineIndicator = document.createElement('div');
    multiLineIndicator.className = 'multi-line-indicator';
    multiLineIndicator.innerHTML = '<i class="fas fa-align-left"></i>';
    textEl.appendChild(multiLineIndicator);
    
    // Check if text has multiple lines
    if (globalTextStyle.text.includes('\n')) {
      textEl.classList.add('multi-line');
    }
    
    // Create controls bar
    const controlsBar = document.createElement('div');
    controlsBar.className = 'text-controls-bar';
    
    // Minus button
    const minusBtn = document.createElement('button');
    minusBtn.className = 'control-btn size-btn size-minus';
    minusBtn.innerHTML = '-';
    minusBtn.title = 'Decrease font size';
    
    // Font size display
    const sizeDisplay = document.createElement('span');
    sizeDisplay.className = 'font-size-display';
    sizeDisplay.textContent = globalTextStyle.fontSize;
    
    // Plus button
    const plusBtn = document.createElement('button');
    plusBtn.className = 'control-btn size-btn size-plus';
    plusBtn.innerHTML = '+';
    plusBtn.title = 'Increase font size';
    
    // Bold button
    const boldBtn = document.createElement('button');
    boldBtn.className = 'control-btn bold-btn';
    if (globalTextStyle.bold) boldBtn.classList.add('active');
    boldBtn.innerHTML = 'B';
    boldBtn.title = 'Bold';
    
    // Italic button
    const italicBtn = document.createElement('button');
    italicBtn.className = 'control-btn italic-btn';
    if (globalTextStyle.italic) italicBtn.classList.add('active');
    italicBtn.innerHTML = 'I';
    italicBtn.title = 'Italic';
    
    // Underline button
    const underlineBtn = document.createElement('button');
    underlineBtn.className = 'control-btn underline-btn';
    if (globalTextStyle.underline) underlineBtn.classList.add('active');
    underlineBtn.innerHTML = 'U';
    underlineBtn.title = 'Underline';
    
    // Color button
    const colorBtn = document.createElement('button');
    colorBtn.className = 'control-btn color-btn';
    colorBtn.title = 'Change color';
    colorBtn.innerHTML = '<div class="color-preview-inline" style="background-color: ' + globalTextStyle.color + ';"></div>';
    
    // Add buttons to controls bar
    controlsBar.appendChild(minusBtn);
    controlsBar.appendChild(sizeDisplay);
    controlsBar.appendChild(plusBtn);
    controlsBar.appendChild(boldBtn);
    controlsBar.appendChild(italicBtn);
    controlsBar.appendChild(underlineBtn);
    controlsBar.appendChild(colorBtn);
    
    textEl.appendChild(controlsBar);
    
    // Delete button
    const del = document.createElement('button');
    del.className = 'delete-btn';
    del.innerHTML = '<i class="fas fa-trash"></i>';
    del.title = 'Delete text';
    del.addEventListener('click', (e)=> {
      e.stopPropagation();
      if (selectedTextElement === textEl) {
        selectedTextElement = null;
        hideColorPicker();
      }
      textEl.remove();
      pd.texts = pd.texts.filter(t => t.id !== id);
      generateBtn.disabled = pageData.every(p=> !p.texts || p.texts.length===0);
    });
    
    textEl.appendChild(del);
    layer.appendChild(textEl);
    
    // Store text data
    const scaleX = pd.pdfSize.width / pd.viewport.width;
    const scaleY = pd.pdfSize.height / pd.viewport.height;
    const pdfX = left * scaleX;
    const pdfTop = top * scaleY;
    
    const stored = { 
      id, 
      x_pdf: pdfX, 
      top_pdf: pdfTop,
      text: globalTextStyle.text,
      fontSize: globalTextStyle.fontSize,
      color: globalTextStyle.color,
      bold: globalTextStyle.bold,
      italic: globalTextStyle.italic,
      underline: globalTextStyle.underline
    };
    
    if (!pd.texts) pd.texts = [];
    pd.texts.push(stored);
    
    // Make draggable
    makeDraggable(textEl, pageIndex, stored);
    
    // Select this new text
    selectTextElement(textEl);
    
    generateBtn.disabled = false;
  }

  function getTextDataFromElement(element) {
    const pageIndex = element.dataset.pageIndex;
    const textId = element.dataset.textId;
    const pd = pageData[pageIndex];
    
    if (!pd || !pd.texts) return null;
    
    return pd.texts.find(t => t.id === textId);
  }

  function makeDraggable(domEl, pageIndex, stored){
    let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;
    const pd = pageData[pageIndex];
    if (!pd) return;
    
    const layer = pd.layerElem;

    const down = (e) => {
      // Don't start drag if clicking on control buttons or delete button
      if (e.target.classList.contains('control-btn') || 
          e.target.classList.contains('delete-btn') ||
          e.target.closest('.control-btn') || 
          e.target.closest('.delete-btn')) {
        return;
      }
      
      // Don't start drag if currently typing
      if (isTypingInText) return;
      
      e.preventDefault();
      dragging = true;
      const cx = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
      const cy = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
      startX = cx; 
      startY = cy;
      startLeft = parseFloat(domEl.style.left || 0);
      startTop = parseFloat(domEl.style.top || 0);
      
      // Select this element when starting to drag
      selectTextElement(domEl);
      
      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', up);
      if (e.type === 'touchstart') {
        document.addEventListener('touchmove', move, {passive:false});
        document.addEventListener('touchend', up);
      }
    };

    const move = (e) => {
      if(!dragging) return;
      e.preventDefault();
      const cx = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
      const cy = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
      const dx = cx - startX, dy = cy - startY;
      let newLeft = startLeft + dx, newTop = startTop + dy;
      
      // Constrain within layer
      if (layer) {
        newLeft = Math.max(0, Math.min(newLeft, layer.clientWidth - domEl.offsetWidth));
        newTop = Math.max(0, Math.min(newTop, layer.clientHeight - domEl.offsetHeight));
      }
      
      domEl.style.left = newLeft + 'px';
      domEl.style.top = newTop + 'px';

      if (pd) {
        const sX = pd.pdfSize.width / pd.viewport.width;
        const sY = pd.pdfSize.height / pd.viewport.height;
        stored.x_pdf = newLeft * sX;
        stored.top_pdf = newTop * sY;
      }
    };

    const up = (e) => {
      dragging = false;
      document.removeEventListener('mousemove', move);
      document.removeEventListener('mouseup', up);
      document.removeEventListener('touchmove', move);
      document.removeEventListener('touchend', up);
    };

    domEl.addEventListener('mousedown', down);
    domEl.addEventListener('touchstart', down, {passive:false});
  }

  // Generate PDF with text
  generateBtn.addEventListener('click', async ()=>{
    if(!selectedPdfFile) { 
      showError('Please upload a PDF first');
      return; 
    }
    
    const hasTexts = pageData.some(pd => pd && pd.texts && pd.texts.length > 0);
    if(!hasTexts) { 
      showError('Add at least one text element');
      return; 
    }
    
    try{
      generateBtn.disabled = true;
      progress.style.display = 'block';
      progressBar.style.width = '6%';

      const ab = await selectedPdfFile.arrayBuffer();
      progressBar.style.width = '18%';
      const pdfDoc = await PDFLib.PDFDocument.load(ab);
      progressBar.style.width = '36%';

      // Embed fonts (Helvetica with variants)
      const helveticaFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
      const helveticaBoldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
      const helveticaObliqueFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaOblique);
      const helveticaBoldObliqueFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBoldOblique);

      progressBar.style.width = '50%';

      const pages = pdfDoc.getPages();
      for(let i=0; i<pages.length; i++){
        const page = pages[i];
        const pd = pageData[i];
        if(!pd || !pd.texts) continue;
        
        for(const t of pd.texts){
          // Convert hex color to RGB
          let hex = t.color;
          if (hex.startsWith('#')) {
            hex = hex.substring(1);
          }
          
          // Handle short hex codes
          if (hex.length === 3) {
            hex = hex.split('').map(c => c + c).join('');
          }
          
          const r = parseInt(hex.substr(0,2), 16) / 255;
          const g = parseInt(hex.substr(2,2), 16) / 255;
          const b = parseInt(hex.substr(4,2), 16) / 255;
          
          // Choose font based on style
          let font;
          if(t.bold && t.italic) {
            font = helveticaBoldObliqueFont;
          } else if(t.bold) {
            font = helveticaBoldFont;
          } else if(t.italic) {
            font = helveticaObliqueFont;
          } else {
            font = helveticaFont;
          }
          
          // Calculate Y position (PDF origin is bottom-left)
          const pdfY = pd.pdfSize.height - t.top_pdf - t.fontSize;
          
          // Split text by newlines and draw each line
          const lines = t.text.split('\n');
          for(let j = 0; j < lines.length; j++) {
            const lineY = pdfY - (j * t.fontSize * 1.2);
            page.drawText(lines[j], {
              x: t.x_pdf,
              y: lineY,
              size: t.fontSize,
              font: font,
              color: PDFLib.rgb(r, g, b)
            });
          }
        }
      }
      
      progressBar.style.width = '86%';
      const out = await pdfDoc.save();
      progressBar.style.width = '96%';

      const blob = new Blob([out], { type:'application/pdf' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      
      const downloadFilename = originalFilename ? `${originalFilename}_with_text.pdf` : `document_with_text.pdf`;
      a.download = downloadFilename;
      
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }, 100);
      
      progressBar.style.width = '100%';
      setTimeout(()=> { 
        progress.style.display='none'; 
        progressBar.style.width='0%'; 
      }, 600);

      // Show success message
      showSuccessMessage('PDF generated and downloaded successfully!');
      
    }catch(err){
      console.error(err);
      showError('Error generating PDF with text: ' + (err.message || err));
      generateBtn.disabled = false;
      progress.style.display = 'none';
      progressBar.style.width = '0%';
    }
  });
  
  function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `
      <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
      <p><strong>Success!</strong></p>
      <p>${message}</p>
    `;
    
    // Insert at the top of preview list
    if (previewList.firstChild) {
      previewList.insertBefore(successDiv, previewList.firstChild);
    } else {
      previewList.appendChild(successDiv);
    }
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (successDiv.parentNode) {
        successDiv.parentNode.removeChild(successDiv);
      }
    }, 5000);
  }

  // Initialize with default style
  console.log('PDF Text Adder Application Loaded Successfully');
  console.log('Ready to accept PDF files');
});
</script>
</body>
</html>
